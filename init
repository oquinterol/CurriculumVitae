#!/bin/bash

# CV BilingÃ¼e - Script de InicializaciÃ³n
# Configura el proyecto para compilaciÃ³n bilingÃ¼e y ejecuta Makefile

set -e

show_help() {
    echo "ğŸ“ CV BilingÃ¼e - Script de InicializaciÃ³n"
    echo ""
    echo "Uso: ./init [COMANDO]"
    echo ""
    echo "Comandos disponibles:"
    echo "  help          - Muestra esta ayuda"
    echo "  setup         - Configura el proyecto inicial"
    echo "  english       - Compila CV en inglÃ©s (default)"
    echo "  spanish       - Compila CV en espaÃ±ol"
    echo "  both          - Compila ambas versiones"
    echo "  clean         - Limpia archivos temporales"
    echo "  status        - Muestra el estado del proyecto"
    echo ""
    echo "Ejemplos:"
    echo "  ./init                # Compila en espaÃ±ol"
    echo "  ./init english        # Compila en inglÃ©s"
    echo "  ./init both           # Compila ambas versiones"
}

check_dependencies() {
    echo "ğŸ” Verificando dependencias..."
    
    if ! command -v xelatex &> /dev/null; then
        echo "âŒ Error: xelatex no estÃ¡ instalado"
        echo "   Instala: sudo apt-get install texlive-xetex (Ubuntu/Debian)"
        exit 1
    fi
    
    if ! command -v make &> /dev/null; then
        echo "âŒ Error: make no estÃ¡ instalado"
        echo "   Instala: sudo apt-get install make (Ubuntu/Debian)"
        exit 1
    fi
    
    echo "âœ… Dependencias verificadas"
}

show_status() {
    echo "ğŸ“Š Estado del Proyecto CV BilingÃ¼e"
    echo "=================================="
    echo ""
    
    # Git status
    if [ -d ".git" ]; then
        CURRENT_BRANCH=$(git branch --show-current)
        echo "ğŸ”€ Branch actual: $CURRENT_BRANCH"
        
        # Check for untracked/modified files
        if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸  Hay cambios sin confirmar"
        else
            echo "âœ… Repositorio limpio"
        fi
    else
        echo "âŒ No es un repositorio git"
    fi
    
    echo ""
    
    # Check for existing PDFs
    echo "ğŸ“„ Archivos PDF disponibles:"
    if [ -f "cv_spanish.pdf" ]; then
        echo "âœ… cv_spanish.pdf ($(stat -c%s cv_spanish.pdf) bytes)"
    else
        echo "âŒ cv_spanish.pdf - No disponible"
    fi
    
    if [ -f "cv_english.pdf" ]; then
        echo "âœ… cv_english.pdf ($(stat -c%s cv_english.pdf) bytes)"
    else
        echo "âŒ cv_english.pdf - No disponible"
    fi
    
    echo ""
    echo "ğŸ› ï¸  Para compilar: ./init [spanish|english|both]"
}

setup_project() {
    echo "ğŸš€ Configurando proyecto CV bilingÃ¼e..."
    
    # Create build directory if it doesn't exist
    mkdir -p build
    
    # Set executable permissions
    chmod +x init
    
    echo "âœ… Proyecto configurado correctamente"
    echo ""
    echo "ğŸ‰ Â¡Listo! Ya puedes compilar tu CV:"
    echo "   ./init          - Compila en espaÃ±ol"
    echo "   ./init english  - Compila en inglÃ©s"
    echo "   ./init both     - Compila ambas versiones"
}

# Main logic
case "${1:-spanish}" in
    "help"|"-h"|"--help")
        show_help
        ;;
    "setup")
        check_dependencies
        setup_project
        ;;
    "status")
        show_status
        ;;
    "english"|"en"|"")
        check_dependencies
        echo "ğŸ‡¬ğŸ‡§ Compilando CV en inglÃ©s..."
        make english
        ;;
    "spanish"|"es")
        check_dependencies
        echo "ğŸ‡ªğŸ‡¸ Compilando CV en espaÃ±ol..."
        make spanish
        ;;
    "both")
        check_dependencies
        echo "ğŸŒ Compilando ambas versiones..."
        make both
        ;;
    "clean")
        echo "ğŸ§¹ Limpiando archivos temporales..."
        make clean
        ;;
    *)
        echo "âŒ Error: Comando desconocido '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac